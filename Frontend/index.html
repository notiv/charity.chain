<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HackZurich2017</title>

    <!-- Jquery -->
    <script src="jquery-3.2.1.min.js"></script>

    <!-- Bootstrap -->
    <script src="bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
    <div class="container border-top border-bottom">
        <div class="row">
            <div class="col-md-5 padding-top" style="height: 100%;">
                <!-- MAP -->
                <div class="globe centered">

                </div>
            </div>
            <div class="col-md-4" style="height: 100%;">
                <div class="row padding-top" style="height: 50%;">
                    <!-- FORM -->
                    <div class="form centered">
                        <h4>DONATE</h4>
                        <form>
                            <div><input type="text" value="100" class="amount">&nbsp;CHF</div>
                            <select class="charities" onchange="onCharitySelect()">
                                <!-- INITIALLY EMPTY -->
                            </select>
                            <button onclick="sendMoney()">DONATE</button>
                        </form>
                    </div>
                </div>
                <div class="row padding-top border-top" style="height: 50%;">
                    <!-- NEWS FOR CHARITY -->
                    <div class="centered">
                        <h4>NEWS</h4>
                        <ul class="news">
                            <!-- INITIALLY EMPTY -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-3" style="height: 100%;">
                <div class="row padding-top" style="height: 70%;">
                    <!-- CAUSES -->
                    <div class="centered">
                        <h4>CAUSES</h4>
                        <ul class="causes">
                            <!-- initially empty -->
                        </ul>
                    </div>
                </div>
                <div class="row padding-top border-top" style="height: 30%;">
                    <!-- TRANSACTION LIST -->
                    <div class="transaction centered">
                        <!-- TODO -->TRANSACTION LIST
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- socket.io -->
    <script src="socket.io.slim.js"></script>
    <!-- app logic -->
    <script>
        const urlPart = '40ccdca6';
        const apiUrl = `http://${urlPart}.ngrok.io:8080`;
        let bcEntities = [];

        /*
         * Socket.io
         */
        // connect to socket.io WS
        // TODO: replace with localhost before delivery
        const socket = io(apiUrl);

        // listen for events
        socket.on('pendingTransaction', data => {
           console.log(data);
        });

        /*
         * UTILITY
         */
        const mapNameToAddress = (charity) => {
            // TODO
        };

        const getCharity = () => $('.charities').find('option:selected').text();

        /*
         * DOM events
         */

        // initiate transaction
        const sendMoney = () => {
            const charity = getCharity();
            const to = mapNameToAddress(charity);
            const amount = $('.amount').val();

            $.post(apiUrl, { to, amount }, () => {
                // no data returned
                console.log('success');
            });
        };

        // display charity-related news
        const onCharitySelect = () => {
            const charity = getCharity();

            $.get(`${apiUrl}/api/news/${charity}`, data => {
                $('.causes').html('');
                data.forEach(item => {
                    $('.causes').appendChild(`<li>${item}</li>`);
                })
            });
        };

        /*
        * INIT
        */
        // fetch data about Blockchain nodes
        $.get(`${apiUrl}/api/entity`, data => {
            bcEntities = data;
        });
    </script>

    <!-- livereload -->
    <script>
        // server: livereloadx
        document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
        + ':35729/livereload.js?snipver=1"></' + 'script>')
    </script>
</body>
</html>